<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1338px" preserveAspectRatio="none" style="width:1272px;height:1338px;" version="1.1" viewBox="0 0 1272 1338" width="1272px" zoomAndPan="magnify"><defs><filter height="300%" id="fonlesuibztrv" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="308" x="478.5" y="28.708">Audit replicas on Member Nodes.</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="0" x="635.5" y="49.6611"/><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacingAndGlyphs" textLength="0" x="635.5" y="70.6143"/><rect fill="#D74F57" filter="url(#fonlesuibztrv)" height="1007.25" style="stroke:#A80036;stroke-width:1.0;" width="10" x="390" y="261.9844"/><rect fill="#FFFFFF" filter="url(#fonlesuibztrv)" height="703.0547" style="stroke:#000000;stroke-width:2.0;" width="1116" x="139" y="446.7813"/><rect fill="#FFFFFF" filter="url(#fonlesuibztrv)" height="59.2656" style="stroke:#000000;stroke-width:2.0;" width="439" x="304" y="540.3125"/><rect fill="#FFFFFF" filter="url(#fonlesuibztrv)" height="529.2578" style="stroke:#000000;stroke-width:2.0;" width="1096" x="149" y="613.5781"/><rect fill="#FFFFFF" filter="url(#fonlesuibztrv)" height="213.9297" style="stroke:#000000;stroke-width:2.0;" width="931" x="304" y="806.5078"/><rect fill="#FFFFFF" filter="url(#fonlesuibztrv)" height="59.2656" style="stroke:#000000;stroke-width:2.0;" width="471" x="304" y="1076.5703"/><rect fill="#FFFFFF" filter="url(#fonlesuibztrv)" height="59.2656" style="stroke:#000000;stroke-width:2.0;" width="524" x="304" y="1202.9688"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="214" x2="214" y1="133.4531" y2="1279.2344"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="395" x2="395" y1="133.4531" y2="1279.2344"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="876.5" x2="876.5" y1="133.4531" y2="1279.2344"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1063.5" x2="1063.5" y1="133.4531" y2="1279.2344"/><rect fill="#FEFECE" filter="url(#fonlesuibztrv)" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="176" x="124" y="81.8594"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="52" x="186" y="101.8545">«CN-1»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="162" x="131" y="118.1514">ReplicaAuditQuartzJob</text><rect fill="#FEFECE" filter="url(#fonlesuibztrv)" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="176" x="124" y="1278.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="52" x="186" y="1298.2295">«CN-1»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="162" x="131" y="1314.5264">ReplicaAuditQuartzJob</text><rect fill="#FEFECE" filter="url(#fonlesuibztrv)" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="158" x="314" y="81.8594"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="52" x="367" y="101.8545">«CN-1»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="321" y="118.1514">ReplicaAuditService</text><rect fill="#FEFECE" filter="url(#fonlesuibztrv)" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="158" x="314" y="1278.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="52" x="367" y="1298.2295">«CN-1»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="321" y="1314.5264">ReplicaAuditService</text><rect fill="#FEFECE" filter="url(#fonlesuibztrv)" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="133" x="808.5" y="81.8594"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="52" x="849" y="101.8545">«CN-1»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="815.5" y="118.1514">ReplicaAuditDao</text><rect fill="#FEFECE" filter="url(#fonlesuibztrv)" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="133" x="808.5" y="1278.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="52" x="849" y="1298.2295">«CN-1»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="815.5" y="1314.5264">ReplicaAuditDao</text><rect fill="#FEFECE" filter="url(#fonlesuibztrv)" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="213" x="955.5" y="81.8594"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="53" x="1035.5" y="101.8545">«CN-Z»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="199" x="962.5" y="118.1514">DistributedExecutorService</text><rect fill="#FEFECE" filter="url(#fonlesuibztrv)" height="46.5938" style="stroke:#A80036;stroke-width:1.5;" width="213" x="955.5" y="1278.2344"/><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="53" x="1035.5" y="1298.2295">«CN-Z»</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="199" x="962.5" y="1314.5264">DistributedExecutorService</text><rect fill="#D74F57" filter="url(#fonlesuibztrv)" height="1007.25" style="stroke:#A80036;stroke-width:1.0;" width="10" x="390" y="261.9844"/><rect fill="#EEEEEE" filter="url(#fonlesuibztrv)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1265" x="0" y="164.0195"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1265" y1="164.0195" y2="164.0195"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1265" y1="167.0195" y2="167.0195"/><rect fill="#EEEEEE" filter="url(#fonlesuibztrv)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="148" x="558.5" y="153.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="129" x="564.5" y="169.52">Replication Audit</text><path d="M5,191.5859 L5,231.5859 L205,231.5859 L205,201.5859 L195,191.5859 L5,191.5859 " fill="#FBFB77" filter="url(#fonlesuibztrv)" style="stroke:#AAAAAA;stroke-width:1.0;"/><path d="M195,191.5859 L195,201.5859 L205,201.5859 L195,191.5859 " fill="#FBFB77" style="stroke:#AAAAAA;stroke-width:1.0;"/><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="11" y="208.6528">Quartz scheduled execution</text><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="11" y="223.7856">of replica audit processing.</text><polygon fill="#A80036" points="378,257.9844,388,261.9844,378,265.9844,382,261.9844" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="214" x2="384" y1="261.9844" y2="261.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="221" y="256.9185">auditReplicas()</text><line style="stroke:#A80036;stroke-width:1.0;" x1="400" x2="442" y1="291.1172" y2="291.1172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="442" x2="442" y1="291.1172" y2="304.1172"/><line style="stroke:#A80036;stroke-width:1.0;" x1="401" x2="442" y1="304.1172" y2="304.1172"/><polygon fill="#A80036" points="411,300.1172,401,304.1172,411,308.1172,407,304.1172" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="407" y="286.0513">aquireReplicaAuditingLock();</text><path d="M670,317.1172 L670,372.1172 L1080,372.1172 L1080,327.1172 L1070,317.1172 L670,317.1172 " fill="#FBFB77" filter="url(#fonlesuibztrv)" style="stroke:#AAAAAA;stroke-width:1.0;"/><path d="M1070,317.1172 L1070,327.1172 L1080,327.1172 L1070,317.1172 " fill="#FBFB77" style="stroke:#AAAAAA;stroke-width:1.0;"/><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="374" x="676" y="334.1841">Query the Metacat replica system metadata replica status</text><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="676" y="349.3169">table for pids of replica records which have not been audited</text><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="375" x="676" y="364.4497">for the audit period length of time.  May be a paged result.</text><polygon fill="#A80036" points="865,398.6484,875,402.6484,865,406.6484,869,402.6484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="400" x2="871" y1="402.6484" y2="402.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="407" y="397.5825">getReplicasByDate()</text><polygon fill="#A80036" points="411,427.7813,401,431.7813,411,435.7813,407,431.7813" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="405" x2="876" y1="431.7813" y2="431.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="417" y="426.7153">List&lt;Identifier&gt; pidsToAudit</text><path d="M139,446.7813 L217,446.7813 L217,453.7813 L207,463.7813 L139,463.7813 L139,446.7813 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="703.0547" style="stroke:#000000;stroke-width:2.0;" width="1116" x="139" y="446.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="33" x="154" y="459.8481">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="260" x="232" y="458.9917">[for each Identifier pid in pidsToAudit]</text><path d="M207,468.9141 L207,523.9141 L578,523.9141 L578,478.9141 L568,468.9141 L207,468.9141 " fill="#FBFB77" filter="url(#fonlesuibztrv)" style="stroke:#AAAAAA;stroke-width:1.0;"/><path d="M568,468.9141 L568,478.9141 L578,478.9141 L568,468.9141 " fill="#FBFB77" style="stroke:#AAAAAA;stroke-width:1.0;"/><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="213" y="485.981">Create ReplicaAuditTasks if not already being handled.</text><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="213" y="501.1138">Tasks can be configured to batch several Identifiers</text><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="213" y="516.2466">into tasks or to create a task for each Identifier.</text><path d="M304,540.3125 L370,540.3125 L370,547.3125 L360,557.3125 L304,557.3125 L304,540.3125 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="59.2656" style="stroke:#000000;stroke-width:2.0;" width="439" x="304" y="540.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="319" y="553.3794">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="385" y="552.5229">[if pid NOT in hzProcessingAuditIdentifiers]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="400" x2="442" y1="578.5781" y2="578.5781"/><line style="stroke:#A80036;stroke-width:1.0;" x1="442" x2="442" y1="578.5781" y2="591.5781"/><line style="stroke:#A80036;stroke-width:1.0;" x1="401" x2="442" y1="591.5781" y2="591.5781"/><polygon fill="#A80036" points="411,587.5781,401,591.5781,411,595.5781,407,591.5781" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="407" y="573.5122">replicaAuditTasks.add(new ReplicaAuditTask(pid));</text><path d="M149,613.5781 L215,613.5781 L215,620.5781 L205,630.5781 L149,630.5781 L149,613.5781 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="529.2578" style="stroke:#000000;stroke-width:2.0;" width="1096" x="149" y="613.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="164" y="626.645">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="311" x="230" y="625.7886">[if replicaAuditTasks.size =&gt; replicaBatchSize]</text><path d="M159,635.7109 L159,705.7109 L626,705.7109 L626,645.7109 L616,635.7109 L159,635.7109 " fill="#FBFB77" filter="url(#fonlesuibztrv)" style="stroke:#AAAAAA;stroke-width:1.0;"/><path d="M616,635.7109 L616,645.7109 L626,645.7109 L616,635.7109 " fill="#FBFB77" style="stroke:#AAAAAA;stroke-width:1.0;"/><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="446" x="165" y="652.7778">accumulatedTaskFuture List holds futures generated on this iteration.</text><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="372" x="165" y="667.9106">futuresToHandle holds futures generated on last iteration.</text><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="165" y="683.0435">Assumption is futures provided to distributed execution service on</text><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="165" y="698.1763">previous iteration should have executed asynch already.</text><line style="stroke:#A80036;stroke-width:1.0;" x1="400" x2="442" y1="736.375" y2="736.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="442" x2="442" y1="736.375" y2="749.375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="401" x2="442" y1="749.375" y2="749.375"/><polygon fill="#A80036" points="411,745.375,401,749.375,411,753.375,407,749.375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="458" x="407" y="731.3091">futuresToHandle = accumulatedTaskFutures;  // futures from last batch</text><line style="stroke:#A80036;stroke-width:1.0;" x1="400" x2="442" y1="778.5078" y2="778.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="442" x2="442" y1="778.5078" y2="791.5078"/><line style="stroke:#A80036;stroke-width:1.0;" x1="401" x2="442" y1="791.5078" y2="791.5078"/><polygon fill="#A80036" points="411,787.5078,401,791.5078,411,795.5078,407,791.5078" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="407" y="773.4419">accumulatedTaskFutures.clear();</text><path d="M304,806.5078 L382,806.5078 L382,813.5078 L372,823.5078 L304,823.5078 L304,806.5078 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="213.9297" style="stroke:#000000;stroke-width:2.0;" width="931" x="304" y="806.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="33" x="319" y="819.5747">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="394" x="397" y="818.7183">[for each ReplicaAuditTask auditTask in replicaAuditTasks]</text><path d="M903,828.6406 L903,868.6406 L1221,868.6406 L1221,838.6406 L1211,828.6406 L903,828.6406 " fill="#FBFB77" filter="url(#fonlesuibztrv)" style="stroke:#AAAAAA;stroke-width:1.0;"/><path d="M1211,828.6406 L1211,838.6406 L1221,838.6406 L1211,828.6406 " fill="#FBFB77" style="stroke:#AAAAAA;stroke-width:1.0;"/><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="297" x="909" y="845.7075">Hazelcast distributed executor service used to</text><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="909" y="860.8403">distribute audit tasks among CN nodes.</text><polygon fill="#A80036" points="1052,895.0391,1062,899.0391,1052,903.0391,1056,899.0391" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="400" x2="1058" y1="899.0391" y2="899.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="407" y="893.9731">submit(auditTask);</text><line style="stroke:#A80036;stroke-width:1.0;" x1="400" x2="442" y1="928.1719" y2="928.1719"/><line style="stroke:#A80036;stroke-width:1.0;" x1="442" x2="442" y1="928.1719" y2="941.1719"/><line style="stroke:#A80036;stroke-width:1.0;" x1="401" x2="442" y1="941.1719" y2="941.1719"/><polygon fill="#A80036" points="411,937.1719,401,941.1719,411,945.1719,407,941.1719" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="407" y="923.106">hzProcessingAuditIdentfiers.removeAll(auditTask.pid);</text><polygon fill="#A80036" points="411,966.3047,401,970.3047,411,974.3047,407,970.3047" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="405" x2="1063" y1="970.3047" y2="970.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="417" y="965.2388">Future replicaTaskFuture;</text><line style="stroke:#A80036;stroke-width:1.0;" x1="400" x2="442" y1="999.4375" y2="999.4375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="442" x2="442" y1="999.4375" y2="1012.4375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="401" x2="442" y1="1012.4375" y2="1012.4375"/><polygon fill="#A80036" points="411,1008.4375,401,1012.4375,411,1016.4375,407,1012.4375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="407" y="994.3716">accumulatedTaskFutures.add(replicaTaskFuture);</text><line style="stroke:#A80036;stroke-width:1.0;" x1="400" x2="442" y1="1048.5703" y2="1048.5703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="442" x2="442" y1="1048.5703" y2="1061.5703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="401" x2="442" y1="1061.5703" y2="1061.5703"/><polygon fill="#A80036" points="411,1057.5703,401,1061.5703,411,1065.5703,407,1061.5703" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="365" x="407" y="1043.5044">replicaAuditTasks.clear(); // prepare for next batch tasks.</text><path d="M304,1076.5703 L382,1076.5703 L382,1083.5703 L372,1093.5703 L304,1093.5703 L304,1076.5703 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="59.2656" style="stroke:#000000;stroke-width:2.0;" width="471" x="304" y="1076.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="33" x="319" y="1089.6372">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="373" x="397" y="1088.7808">[for each Future replicaTaskFuture in futuresToHandle]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="400" x2="442" y1="1114.8359" y2="1114.8359"/><line style="stroke:#A80036;stroke-width:1.0;" x1="442" x2="442" y1="1114.8359" y2="1127.8359"/><line style="stroke:#A80036;stroke-width:1.0;" x1="401" x2="442" y1="1127.8359" y2="1127.8359"/><polygon fill="#A80036" points="411,1123.8359,401,1127.8359,411,1131.8359,407,1127.8359" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="407" y="1109.77">handleResult(replicaTaskFuture.get());</text><path d="M239,1161.8359 L239,1186.8359 L547,1186.8359 L547,1171.8359 L537,1161.8359 L239,1161.8359 " fill="#FBFB77" filter="url(#fonlesuibztrv)" style="stroke:#AAAAAA;stroke-width:1.0;"/><path d="M537,1161.8359 L537,1171.8359 L547,1171.8359 L537,1161.8359 " fill="#FBFB77" style="stroke:#AAAAAA;stroke-width:1.0;"/><text fill="#222222" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="287" x="245" y="1178.9028">Handle futures from last batch of audit tasks</text><path d="M304,1202.9688 L382,1202.9688 L382,1209.9688 L372,1219.9688 L304,1219.9688 L304,1202.9688 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="59.2656" style="stroke:#000000;stroke-width:2.0;" width="524" x="304" y="1202.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="33" x="319" y="1216.0356">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="426" x="397" y="1215.1792">[for each Future replicaTaskFuture in accumulatedTaskFutures]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="400" x2="442" y1="1241.2344" y2="1241.2344"/><line style="stroke:#A80036;stroke-width:1.0;" x1="442" x2="442" y1="1241.2344" y2="1254.2344"/><line style="stroke:#A80036;stroke-width:1.0;" x1="401" x2="442" y1="1254.2344" y2="1254.2344"/><polygon fill="#A80036" points="411,1250.2344,401,1254.2344,411,1258.2344,407,1254.2344" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="407" y="1236.1685">handleResult(replicaTaskFuture);</text><!--MD5=[9d18e2275a852aeab8dfdf2b35cd60fe]
@startuml
skinparam notebordercolor #AAAAAA
 skinparam notefontcolor #222222
 title Audit replicas on Member Nodes.\n\n
 participant "ReplicaAuditQuartzJob" as cnQuartz <<CN-1>>
 participant "ReplicaAuditService" as cnAudit <<CN-1>>
 participant "ReplicaAuditDao" as auditDao <<CN-1>>
 participant "DistributedExecutorService" as cnZ <<CN-Z>>

== Replication Audit ==

  note left of cnQuartz
   Quartz scheduled execution
   of replica audit processing.
  end note

    cnQuartz -> cnAudit : auditReplicas()
  activate cnAudit #D74F57

    cnAudit -> cnAudit : aquireReplicaAuditingLock();

  note over auditDao
    Query the Metacat replica system metadata replica status
    table for pids of replica records which have not been audited
    for the audit period length of time.  May be a paged result.
  end note
  cnAudit -> auditDao : getReplicasByDate()
  cnAudit <- - auditDao : List<Identifier> pidsToAudit

  loop for each Identifier pid in pidsToAudit
    note over cnAudit
      Create ReplicaAuditTasks if not already being handled.
      Tasks can be configured to batch several Identifiers
      into tasks or to create a task for each Identifier.
    end note
      alt if pid NOT in hzProcessingAuditIdentifiers
        cnAudit -> cnAudit : replicaAuditTasks.add(new ReplicaAuditTask(pid));
      end
      alt if replicaAuditTasks.size => replicaBatchSize
        note over cnAudit
            accumulatedTaskFuture List holds futures generated on this iteration.
            futuresToHandle holds futures generated on last iteration.
            Assumption is futures provided to distributed execution service on
            previous iteration should have executed asynch already.
        end note
        cnAudit -> cnAudit : futuresToHandle = accumulatedTaskFutures;  // futures from last batch
        cnAudit -> cnAudit : accumulatedTaskFutures.clear();
        loop for each ReplicaAuditTask auditTask in replicaAuditTasks
          note over cnZ
            Hazelcast distributed executor service used to
            distribute audit tasks among CN nodes.
          end note
          cnAudit -> cnZ : submit(auditTask);
          cnAudit -> cnAudit : hzProcessingAuditIdentfiers.removeAll(auditTask.pid);
          cnZ - -> cnAudit : Future replicaTaskFuture;
          cnAudit -> cnAudit : accumulatedTaskFutures.add(replicaTaskFuture);
        end loop
        cnAudit -> cnAudit : replicaAuditTasks.clear(); // prepare for next batch tasks.
        loop for each Future replicaTaskFuture in futuresToHandle
          cnAudit -> cnAudit : handleResult(replicaTaskFuture.get());
        end loop
      end
  end loop
  note over cnAudit
      Handle futures from last batch of audit tasks
  end note
  loop for each Future replicaTaskFuture in accumulatedTaskFutures
      cnAudit->cnAudit: handleResult(replicaTaskFuture);
  end loop
  deactivate cnAudit
@enduml

PlantUML version 1.2020.21beta3(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>