@startuml images/morpho_save_new_package_seq.png

   participant ": OpenPackageCommand " as open_package_command <<Morpho>>
   participant ": ResultPanel " as result_panel <<Morpho Query Result>>
   participant ": DataStoreController" as data_store_controller <<Morpho>>
   participant "dataStore: DataStore" as data_store <<D1_lib>>
   participant "abstractScienceMetadata: AbstractScienceMetadata" as abstract_metadata <<Morpho>>
   participant "entity: Entity" as entity <<Morpho>>
   participant "dataPackage: DataPackage" as d1_datapackage <<D1_lib>>

   activate open_package_command
   open_package_command -> result_panel: getSelectId(),getDataStore()
   open_package_command <- result_panel: oreID, dataStore
   open_package_command -> data_store_controller: read(oreID, dataStore)
   activate data_store_controller
   data_store_controller -> data_store: get(oreID)
   activate data_store
   data_store_controller <- data_store: Output stream of the ore document 
   data_store_controller -> data_store: getSystemMetadata(oreID)
   data_store_controller <- data_store: systemMeta object
   deactivate data_store
   data_store_controller -> data_store_controller: parse the ORE input stream and get list of ids of the metadata and data objects
   data_store_controller -> d1_datapackage: create the dataPackage object
   activate d1_datapackage  
   data_store_controller -> data_store: read(metadataId,storeId)
   activate data_store
   data_store_controller <- data_store: abstractScienceMetadata
   deactivate data_store
   data_store_controller -> d1_datapackage: dataPackage.add(abstractMetadata)
   loop iterate the entityId list    
       data_store_controller -> data_store: read(entityId, dataStore)
       activate data_store
       data_store_controller <- data_store: entity
       deactivate data_store
       data_store_controller-> d1_datapackage: dataPackage.add(entity)
   end
   data_store_controller -> d1_datapackage: dataPackage.addRelationShip()
   deactivate data_store_controller
   open_package_command <- d1_datapackage: dataPackage
   deactivate d1_datapackage
   deactivate open_package_command
  @enduml
