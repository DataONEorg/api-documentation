@startuml images/morpho_save_new_package_seq.png

  
   participant "abractPackage: AbstractDataPackage" as abstract_package <<Morpho>>
   participant ": FileSystemDataStore" as data_store <<Morpho>>
   participant ": MorphoOREDataPackage extends DataPackage" as d1_datapackage <<Morpho>>
   participant ": MorphoD1Object extends D1Object" as d1_object <<Morpho>>
   participant ": Entity" as entity <<Morpho>>
   
   abstract_package -> data_store: serialize(LOCAL)
   activate data_store
   abstract_package <- data_store: save(abstractPackage)
   data_store -> d1_datapackage: buildOREDataPackage(abstractPackage)  
   abstract_package  -> d1_datapackage: getOREDataPackage()
   activate d1_datapackage
   abstract_package -> data_store: getIdentifer() for the metadata id
   abstract_package -> data_store: getMetadata()
   abstract_package -> data_store: getMetadataSystemMetadata()
   data_store -> data_store: modify some sysMetadata such as size, checksum, modification time
   data_store -> d1_object: create a d1Object for the metadata with the metadata id
   activate d1_object
   d1_object -> d1_object: setSystemMetadata()
   abstract_package -> d1_object: getPreviousIdentifier(), isNewMetadata(),isDirty()
   d1_object -> d1_object: setPreviousIdentifier(), setIsNew(), setIsDirty()
   d1_datapackage <- d1_object: addData(d1Object)
   deactivate d1_object
   abstract_package -> data_store: getEntityList()
   loop iterate the entity list 
      data_store <- entity: getIdentifier()
      data_store <- entity: getSource()
      data_store <- entity: getSystemMetadata()
      data_store -> data_store: modify some sysMetadata such as modification time
      data_store -> d1_object: create d1Object for the data
      activate d1_object
      d1_object -> d1_object: setSystemMetadata()
      entity -> d1_object: getPreviousIdentifier(), isNewMetadata(),isDirty()
      d1_object -> d1_object: setPreviousIdentifier(), setIsNew(), setIsDirty()
      d1_datapackage <- d1_object: addData(d1Object)
      deactivate d1_object
   end
   d1_datapackage -> d1_datapackage: addRelationship()
   d1_datapackage -> d1_datapackage: getSystemMetadata()
   d1_datapackage -> d1_datapackage: modify some sysMetadata such as size, checksum, modification time
   d1_datapackage -> d1_datapackage: setSystemMetadata()
   d1_datapackage -> d1_object: save()
   d1_object -> d1_object: createLocal()(including do nothing)/updateLocal()
   deactivate d1_object
   deactivate d1_datapackage
   deactivate data_store
  @enduml
