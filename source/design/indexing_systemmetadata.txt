Indexing System and Science Metadata for Discovery Support
==========================================================


The main goals for indexing system metadata are:

1. Support access control rules for search results

2. Support efficient discovery of objects by their properties

3. Augment the science metadata indexes with content from 1 and 2

To enable such functionality, three separate indexes will be generated using
SOLR as the indexing and search engine. The three indexes parallel the three
goals above:

:Permission Index:

  Contains a list of subjects with permission to read the object with the
  identifier shared with each record. Values are obtained from the system
  metadata accessPolicy element.

:System Index:

  Contains the bulk of the system metadata values. This index is used primarily
  to support low level access mechanisms such as the DataONE drive.

:Discovery Index:

  Contains elements retrieved from science metadata documents, possibly
  augmented by operations improving the consistency of entries (e.g. consistency
  of keywords) or augmenting from other sources (e.g. georeferencing from
  location descriptions or cross referencing scientific name authorities).

Each of these three indices can operate independently, though will typically be
combined through the SOLR sharding mechanism to combine capabilities to ensure
that the requesting subject will only be presented with results that match their
query and for which they have read permission.



Indexing Process
----------------

The general process of indexing content involves retrieving a System Metadata
document, parsing out the permission rules to generate a SOLR permission
document, parsing the system metadata elements to generate a SOLR system
metadata document, the retrieving and parsing the science metadata to generate a
SOLR discovery document. Each of the generated documents is added to the
corresponding SOLR index using the SOLR update API.

.. figure:: images/cnsolr_index.png

   Figure 1. Approximate sequence of operations for indexing content. The
   trigger may be initiated manually or through a messaging service. SOLR,
   SOLRY, and SOLRP represent three separate SOLR indexes that are intended to
   be combined through sharding. The index SOLRY holds the bulk of the System
   Metadata fields, and the index SOLRP holds READ permissions associated with
   each object. The index SOLR contains metadata to assist with the general
   discovery process.

..
  @startuml images/cnsolr_index.png
  participant trigger
  participant "ObjectStore" as objectStore
  participant "Indexer" as indexer
  participant "SOLRP" as solrp
  participant "SOLRY" as solry
  participant "SOLR" as solr
  
  trigger -> indexer: doIndex(PID)
  activate indexer
  indexer -> objectStore: getSystemMetadata(PID)
  objectStore --> indexer: systemMetadataXML
  indexer -> indexer: permissionIndexDoc = generatePermissionDoc(systemMetadataXML)
  indexer -> solrp: update(permissionIndexDoc)
  indexer -> indexer: sysMetaObject = parseSystemMeta(systemMetadataXML)
  indexer -> indexer: sysMetaIndexDoc = generateSystemMetaDoc(sysMetaObject)
  indexer -> solry: update(sysMetaIndexDoc)
  indexer -> indexer: objectFormat = getObjectFormat(sysMetaObject)
  
  alt objectFormat is Science Metadata
    indexer -> indexer: parser = loadParser(objectFormat)
    indexer -> objectStore: get(PID)
    objectStore --> indexer: sciMetaDoc
    indexer -> indexer: solrDoc = parser.parseMeta(sciMetaDoc)
    indexer -> solr: update(solrDoc)    
  end

  deactivate indexer
  @enduml




The Permission Index
--------------------

The permission index contains a list of groups and individuals that have
permission to READ the object identified by PID. The permission index contains
an entry for each object in the system and MUST be updated in concert with the
formal permission changes on any object as they become known to the Coordinating
Node. The permission index entries are generated by evaluating the access
control rules reported in the system metadata associated with the object.


.. list-table::
   :header-rows: 1
   :widths: 10 5 4 1

   - - Property
     - SOLR term
     - SOLR Type
     - Multi
   - - identifier
     - pid
     - string
     - N
   - - accessPolicy/allow/subject (READ, contains public user)
     - ispublic
     - boolean
     - N
   - - accessPolicy/allow/subject (READ, isGroup)
     - readgroups
     - string
     - Y
   - - accessPolicy/allow/subject (READ, not is Group)
     - readsubjects
     - string
     - Y


The System Index
----------------

The system index contains values drawn from the bulk of the system metadata
records. This index should be updated frequently with changes to system metadata
documents, though latency may be greater than for the permission index.

.. list-table::
   :header-rows: 1
   :widths: 10 5 4 1
   
   - - Property
     - SOLR term
     - SOLR Type
     - Multi
   - - identifier
     - pid
     - string
     - N
   - - objectFormat
     - objectformat
     - string
     - N
   - - size
     - size
     - long
     - N
   - - checksum
     - checksum
     - string
     - N
   - - submitter
     - submitter
     - string
     - N
   - - rightsHolder
     - rightsholder
     - string
     - N
   - - replicationPolicy/\@replicationAllowed
     - rep_allowed
     - boolean
     - N
   - - replicationPolicy/\@numberReplicas
     - n_replicas
     - integer
     - N
   - - replicationPolicy/preferredMemberNode
     - pref_rep_mn
     - string
     - Y
   - - replicationPolicy/blockedMemberNode
     - blocked_rep_mn
     - string
     - Y
   - - obsoletes
     - obsoletes
     - string
     - Y
   - - obsoletedBy
     - obsoletedby
     - string
     - Y
   - - resourceMap
     - resourcemap
     - string
     - Y
   - - dateUploaded
     - dateuploaded
     - date
     - N
   - - dateSysMetadataModified
     - datemodified
     - date
     - N
   - - originMemberNode
     - origin_mn
     - string
     - N
   - - authoritativeMemberNode
     - auth_mn
     - string
     - N
   - - replica/replicaMemberNode
     - replica_mn
     - string
     - Y



The Discovery Index
-------------------

This is an early DRAFT of the discovery index fields. Needs to be cross
referenced with existing Mercury index elements and the search requirements.

The primary purpose of this index is to support discovery operations that would
typically be supported through the Mercury web interface, though may also be
implemented by programmatic actions through clients or through third party
implementations of web interfaces.


.. list-table::
   :header-rows: 1
   :widths: 10 5 4 1
   
   - - Property
     - SOLR term
     - SOLR Type
     - Multi
   - - identifier
     - pid
     - string
     - N
   - - combined from all fields
     - any
     - text
     - N
   - - 
     - author
     - string
     - Y
   - - 
     - keyword
     - string
     - Y
   - - 
     - keyconcept
     - string
     - Y
   - - Decimal degrees
     - latitude
     - float
     - Y
   - - Decimal degrees
     - longitude
     - float
     - Y
   - - Geohash computed from lat/long pairs
     - geohash
     - string
     - Y
   - - Minimum latitude
     - min_latitude
     - float
     - N
   - - Minimum longitude
     - min_longitude
     - float
     - N
   - - Maximum latitude
     - max_latitude
     - float
     - N
   - - Maximum longitude
     - max_longitude
     - float
     - N
   - - Named localities
     - named_location
     - string
     - Y
   - - 
     - temporal_start
     - date
     - N
   - - 
     - temporal_end
     - date
     - N
   - - 
     - title
     - text
     - N
   - - 
     - variablename
     - string
     - Y
   - - 
     - scientificname
     - string
     - Y
   - - datePublished
     - date_published
     - date
     - N
   - - dateAddedToRepository
     - date_added
     - date
     - N
   - - dateSysMetaModified
     - date_modified
     - date
     - N
   - - related objects drawn from resource map
     - related_pids
     - string
     - Y
   - - related organizations drawn from science metadata
     - related_organizations
     - string
     - Y


