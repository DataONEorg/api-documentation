Content Discovery
=================

.. module:: SearchMetadata

Searching for content is a functionality that is primarily supported by
Coordinating Nodes, programmatically through the CN_read.search method, and
through the user interface which is based on Mercury_.

There are two search backends, one implemented by Metacat, the other by a SOLR
index that is populated with information extracted from system and science
metadata.

This document describes the properties of the SOLR index, how it is populated,
and how it can be used to support programmatic search and introspection into the
DataONE holdings.


Properties of the Index
-----------------------

Descriptions of the SOLR fields available and the content that provides the
field values.

**Table 1.** Elements derived from System Metadata and available for all objects.

.. list-table::
   :widths: 3 2 1 10

   * - Attribute
     - Type
     - Multi?
     - Content Origin
   * - pid
     - string, unique
     - No
     - :attr:`SystemMetadata.identifier`
   * - objectFormat
     - string
     - No
     - :attr:`SystemMetadata.objectFormat`
   * - isMetadata
     - boolean
     - No
     - :attr:`SystemMetadata.objectFormat`, scienceMetadata element
   * - isData
     - boolean
     - No
     - True if the object is flagged as data. **Note: there's currently no way to know this.**
   * - isResourceMap
     - boolean
     - No
     - True if the objectFormatName starts with "http://www.openarchives.org/ore/"
   * - size
     - long
     - No
     - :attr:`SystemMetadata.size`
   * - checksum
     - string
     - No
     - :attr:`SystemMetadata.checksum`
   * - checksumAlgorithm
     - string
     - No
     - :attr:`SystemMetadata.algorithm`
   * - submitter
     - string
     - No
     - :attr:`SystemMetadata.submitter`
   * - rightsHolder
     - string
     - No
     - :attr:`SystemMetadata.rightsHolder`
   * - rep_allowed
     - boolean
     - No
     - :attr:`SystemMetadata.replicationPolicy` replicationAllowed attribute
   * - n_replicas
     - integer
     - No
     - :attr:`SystemMetadata.replicationPolicy` numberReplicas attribute
   * - pref_rep_mn
     - string
     - Yes
     - :attr:`SystemMetadata.replicationPolicy` preferredMemberNode
   * - blocked_rep_mn
     - string
     - Yes
     - :attr:`SystemMetadata.replicationPolicy` blockedMemberNode
   * - obsoletes
     - string
     - No
     - :attr:`SystemMetadata.obsoletes`
   * - obsoletedBy
     - string
     - No
     - :attr:`SystemMetadata.obsoletedBy`
   * - dateUploaded
     - date
     - No
     - :attr:`SystemMetadata.dateUploaded`
   * - datemodified
     - date
     - No
     - :attr:`SystemMetadata.dateSysMetadataModified`
   * - origin_mn
     - string
     - No
     - :attr:`SystemMetadata.originMemberNode`
   * - auth_mn
     - string
     - No
     - :attr:`SystemMetadata.authoritativeMemberNode`
   * - replica_mn
     - string
     - Yes
     - :attr:`SystemMetadata.replicaMemberNode`
   * - readPermission
     - string
     - Yes
     - List of subjects (groups and individuals) that have read permission on
       PID, value retrieved from :attr:`SystemMetadata.accessPolicy`.
   * - writePermission
     - string
     - Yes
     - As for readPermission
   * - executePermission
     - string
     - Yes
     - As for readPermission
   * - changePermission
     - string
     - Yes
     - As for readPermission
   * - isPublic
     - boolean
     - No
     - Set to True if the DataONE public user is present in the list of subjects
       with readPermission on PID.
   * - resourceMaps
     - string
     - Yes
     - List of resource maps that reference this PID.
   * - contains
     - string
     - Yes
     - A list of all objects referenced by a resource map. Only populated if
       the current object is a resource map.
   * - describes
     - string
     - Yes
     - Lists all PIDs that this object describes. Obtained by parsing all
       resource maps in which this object is referenced. Not set for data or
       resource map objects.
   * - describedBy
     - string
     - Yes
     - Lists all PIDs that describe this object. Obtained by parsing all
       resource maps in which this object is referenced.


Populating Permission Fields
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

This process is fairly straight forward, and requires simply de-duping entries
so that each of the permission fields contains a distinct list of subjects
granted that permission. If the DataONE public user is present in the read
permissions, then the isPublic field is set to True.


Populating Object Relation Fields
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The fields *resourceMaps*, *contains*, *describes*, and *describedBy* contain
identifiers of other objects in the DataONE system related to the subject of
the current record. These relationships are recorded in OAI-ORE resource map
documents as described in the section :doc:`DataPackage`. Since the values for
these fields are contained in resource maps, it is necessary to build these
fields in progression as additional resource maps are synchronized with the
coordinating nodes.

As a general strategy it is recommended that resource maps are indexed first,
filling the *contains* entries for each map. Then each object that is not a
resource map is indexed in turn. For each object, a query is issued against
the index to retrieve the list of resource maps in which the object identifier
is present, enabling population of the *resourceMaps* field for the object.
Each of those resource maps is examined to obtain the list of identifiers for
the *describes* field if the object is science metadata, and the *decribedBy*
field if the object is data.


Limitations of Multi-Valued Fields in SOLR
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Multi-valued fields in SOLR have an internal representation that can be
likened to a delimited concatenation of all the values for the field. The
fields have a configurable limit to the maximum field size, which defaults to
10000 characters, and this limit may be encountered in the various entries
such as the permission fields or object relation fields where a potentially
large number of subjects or identifiers may be stored.

.. TODO:: Strategies for dealing with these limits when reached. Change
          config, use proxies for values


.. _Mercury: http://mercury.ornl.gov/

.. _OAI-ORE: http://www.openarchives.org/ore/


Metadata Attributes
-------------------

Indexing the system metadata entries provides a mechanism for selection of
content using low level attributes of the objects such as the type, size and
relationships, however is not useful for locating content relevant to a
particular topic or purpose. The :term:`science metadata` contains such
information and such objects contain additional information described below
when indexed by the DataONE system.

The initial web user interface to DataONE utilizes the Mercury_ system. This
in turn relies upon a SOLR index to support the search, faceting, and
sub-setting operations that are exposed through Mercury. The underlying SOLR
index is also exposed through as an API, so other clients (such as the file
system driver) can leverage the search capabilities thus provided.

The remainder of this document describes the search properties that are
extracted from the various formats and syntaxes of of science metadata that
are supported by the DataONE indexing system.

..
  Searching content in DataONE involves the process of matching a user provided
  value with some value extracted from the science metadata.

  Values can be simple (e.g. string, integer, floating point, date) or compound
  (e.g. spatial coordinate constructed from two floats - the latitude and
  longitude and a string - the coordinate system identifier).

  Expression in science metadata

  Expression in extracted values that are indexed

  Expression in a query



Search Element Types
~~~~~~~~~~~~~~~~~~~~

* Integer

* Float

* String

* DateTime

* SpatialFeature (use `Well Known Text`_ )

* Publication (A structured type, perhaps search by decomposing to elements)

* ScientificName (A structured type, perhaps search by decomposing to elements)


.. _Well Known Text: http://en.wikipedia.org/wiki/Well-known_text


Search Terms
------------

.. list-table::
   :widths: 3 2 1 1 10

   * - Attribute
     - Type
     - Multi?
     - In UI?
     - Content Origin
   * - :attr:`author`
     - string
     - No
     - Yes
     - 
   * - :attr:`keyWord`
     - string
     - Yes
     - Yes
     - 
   * - :attr:`keyConcept`
     - string
     - Yes
     -
     -
   * - :attr:`minLatitude`
     - float
     - No
     - Yes
     - Minimum bounding box latitude in degrees, WGS84
   * - :attr:`maxLatitude`
     - float
     - No
     - yes
     - Maximum bounding box latitude in degrees, WGS84
   * - :attr:`minLongitude`
     - float
     - No
     - Yes
     - Minimum bounding box longitude in degrees, WGS84
   * - :attr:`maxLongitude`
     - float
     - No
     - Yes
     - Maximum bounding box longitude in degrees, WGS84
   * - :attr:`namedLocation`
     - string
     - Yes
     - Yes
     - 
   * - :attr:`temporalCoverageStart`
     - date
     - No
     - Yes
     - 
   * - :attr:`temporalCoverageEnd`
     - date
     - No
     - Yes
     - 
   * - :attr:`any`
     - text
     - No
     - Yes
     - 
   * - :attr:`title`
     - String
     - No
     - Yes
     - 
   * - :attr:`objectFormat`
     - string
     - No
     - No
     - 
   * - :attr:`variableNme`
     - string
     - Yes
     - Yes
     -
   * - :attr:`scientificName`
     - string
     - Yes
     - Yes
     - 
   * - :attr:`submitter`
     - string
     - No
     - No
     - 
   * - :attr:`relatedOrganizations`
     - string
     - Yes
     - No
     - 
   * - :attr:`size`
     - long integer
     - No
     - Yes 
     -
   * - :attr:`replicaLocation`
     - string
     - No
     - No
     - 
   * - :attr:`identifier`
     - string
     - Yes
     - 
     - Remove this - Same as pid
   * - :attr:`datePublished`
     - date
     - No
     - Yes
     - 
   * - :attr:`dateAddedToRepository`
     - date
     - No
     - No
     - 
   * - :attr:`dateSysMetadataModified`
     - date
     - No
     - No
     - Remove this - duplicate from sysmeta


.. attribute:: author

  (String) Principle Investigator (PI) / Author

  Name authority service is desired for some control over names appearing in
  metadata For search, advantages to keep simple text representation Goal of
  gradual increase in specificity - Desireable if we can get "sort friendly"
  results -> recommend LAST, FIRST name - Mercury UI


.. attribute:: keyWord

  (String) Keyword (uncontrolled keywords)

  - Mercury enhances the kw list with e.g. GCMD keyword list
  - Mercury UI


.. attribute:: keyConcept

  Key concept -key concepts drawn from a set of ontologies Term Namespace

  - Controlled lists of terms available for several metadata standards
  - A topic being addressed by the semantics WG
  - Unlikely to be available in 2011
  - Giri has some keyword enhancement and mapping script (magic)
  - Mercury UI


.. attribute:: spatialFeature

  (SpatialFeature)
  - Spatial bounding box (largest bounding rectangle)
  - Spatial window (series of spatial envelopes representative of the spatial locations of where the data is collected from or relevant to)
  - Spatial features (points, bounding boxes, polygons)
  - Centroid
  - Bounding box
  - Polygon
  - (not largest extent)
  - (need to resolve the semantics of the bounding box search - e.g. if centroids are recorded but fall outside of bounding box search)
  - Bounding box with contains or overlaps 
  - can be supported by SOLR and Metacat searches
  - Mercury UI


.. attribute:: namedLocation

  (String) Named places Term Type Context (Columbus OH, Columbus GA) Namespace
  of gazetteer

  - free text search field
  - provide recommendations for representation (see Wieczorek's georeferencing document)
  - Mercury UI


.. attribute:: temporalCoverageStart

  (DateTime)

  - temporal extent
  - "jurassic" vs "date collected for jurassic specimen"
  - not publication date, not creation date
  - Applicability date (as opposed to collection date or publication date -- though searching on collection date is a secondary search).  Multiple dates possible:  Collection/observation date, coverage date, analysis date, publication date, metadata modification date (e.g. peat bog samples relevant to 50,000 - 10,000 BCE, collected in July 1980, re-analyzed in July 2008, published in January 2010, and metadata revised in June 2010).  In this example, earliestDate applies to 50,000 BCE.  
  - Mercury UI


.. attribute:: temporalCoverageEnd

  (DateTime) Temporal window
  Relative terms (e.g. terms from the Geologic time scale) need to be supported
  Date ranges
  Temporal coverage of the data set (e.g. searches - during, before, after)

  - same notes as above apply
  - Mercury UI


.. attribute:: any

  (String) Full text search / Text search on abstract - Mercury UI


.. attribute:: title

  (string) Title (2) - Mercury UI


.. attribute:: objectFormat

  (String) Type of data (format) (2)
  
  - Original data
  - Summarized versions
  - Method used for processing (to generate summary, or original data)
  - Resource type (spatial, models, observations, web service, ...)
  - search the system metadata value, but need to parse system metadata of related objects to determine the objectFormat(s) of the data.
  - Potential for mapping the values appearing the science metadata to the controlled terms available in the object format registry
  - label should be "content type"


.. attribute:: variableName

  (String) Scientific variables (from a controlled vocabulary) (1)

  - not in Dryad, optional in most/all
  - Mercury UI


.. attribute:: scientificName

  (String)  Biological taxonomic extents (1)

  - lots of opportunities for cleanup services from ITIS, EOL, etc
  - Mercury UI


.. attribute:: submitter

  (String) 

  - for either data or metadata
  - Principal that added the content to the MN
  - Needs to be translated from the subject to the individual's name


.. attribute:: relatedObject

  (String)  Related data (data sets, publications)

  - given a PID find everything that refers to it (deprecated, describes, derivedFrom...)
  - This should probably be specific to relation type - find all stuff derivedFrom PID


.. attribute:: quality

  (String, controlled vocabulary) Quality / level of curation


.. attribute:: relatedOrganizations

  (String) Organizations involved in study

  - low priority


.. attribute:: size

  (Integer, long) Size of data (bytes)

  - needed for drive, display, not necessary for UI search


.. attribute:: replicaLocation

  (String)  Number / location of replicas


.. attribute:: identifier

  (Types.IdentifierType) Identifier (PID)

  - Need to be able to find metadata records describing a dataset identified by PID
  - Find any science metadata that is or describes PID
  - Mercury UI


.. attribute:: datePublished

  - drawn from science metadata
  - is this the same as publication date concept in datacite - Yes
  - Mercury UI


.. attribute:: dateAddedToRepository

  - first submission to Member Node (drawn from science metadata if available, otherwise system metadata)


.. attribute:: dateSysMetadataModified

  (DateTime) available from sysmeta


.. attribute:: readPrincipal

  - element in permission index, used for shard query


.. attribute:: writePrincipal

  (Types.PrincipalType) Permissions on objects (e.g. available to read by user)

  - element in permission index, used for shard query



